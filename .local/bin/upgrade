#!/usr/bin/env bash

set -e

__USAGE="Upgrade programs and libraries managed by apt, uv, rustup and other.

USAGE:
	$(basename $0) [-h|--help] [-p|--prompt] [-s|--skip SKIP] [RUN]...

SKIP: Skip selected tool(s), overrides RUN.
	apt          Skip apt upgrade
	snap         Skip snap refresh
	uv           Skip uv upgrade
	rust         Skip rustup update
	binenv       Skip binenv upgrade
	zsh          Skip zsh update
	vim          Skip (neo)vim updates (vim-plug, coc)
	extras       Skip all but apt upgrade

RUN: Run only selected tool(s), can be overridden by SKIP.
	apt          Run only apt upgrade
	snap         Run only snap refresh
	uv           Run only uv upgrade
	rust         Run only rustup update
	binenv       Run only binenv upgrade
	zsh          Run only zsh update
	vim          Run only (neo)vim updates (vim-plug, coc)
"

usage() {
  echo "$__USAGE"
}

PROMPT=1

RUN_APT=0
RUN_SNAP=0
RUN_UV=0
RUN_RUST=0
RUN_BINENV=0
RUN_ZSH=0
RUN_VIM=0

POSITIONAL_ARGS=()

while [[ $# -gt 0 ]]; do
  case $1 in
    -h | --help)
      usage
      exit 0
      ;;
    -p | --prompt)
      PROMPT=0
      shift
      ;;
    -s | --skip)
      case "$2" in
        apt)
          RUN_APT=$((RUN_APT - 2))
          ;;
        snap)
          RUN_SNAP=$((RUN_SNAP - 2))
          ;;
        uv)
          RUN_UV=$((RUN_UV - 2))
          ;;
        rust)
          RUN_RUST=$((RUN_RUST - 2))
          ;;
        binenv)
          RUN_BINENV=$((RUN_BINENV - 2))
          ;;
        zsh)
          RUN_ZSH=$((RUN_ZSH - 2))
          ;;
        vim)
          RUN_VIM=$((RUN_VIM - 2))
          ;;
        extras)
          RUN_SNAP=$((RUN_SNAP - 2))
          RUN_UV=$((RUN_UV - 2))
          RUN_RUST=$((RUN_RUST - 2))
          RUN_BINENV=$((RUN_BINENV - 2))
          RUN_ZSH=$((RUN_ZSH - 2))
          RUN_VIM=$((RUN_VIM - 2))
          ;;
        *)
          echo "Unknown skip option value $2"
          usage
          exit 1
          ;;
      esac
      # move past argument and value
      shift
      shift
      ;;
    --* | -*)
      echo "Unknown option $1"
      usage
      exit 1
      ;;
    *)
      # save positional arg
      POSITIONAL_ARGS+=("$1")
      shift
      ;;
  esac
done

# restore positional parameters
set -- "${POSITIONAL_ARGS[@]}"

if [[ $# -eq 0 ]]; then
  RUN_APT=$((RUN_APT + 1))
  RUN_SNAP=$((RUN_SNAP + 1))
  RUN_UV=$((RUN_UV + 1))
  RUN_RUST=$((RUN_RUST + 1))
  RUN_BINENV=$((RUN_BINENV + 1))
  RUN_ZSH=$((RUN_ZSH + 1))
  RUN_VIM=$((RUN_VIM + 1))
else
  while [[ $# -gt 0 ]]; do
    case $1 in
      apt)
        RUN_APT=$((RUN_APT + 1))
        shift
        ;;
      snap)
        RUN_SNAP=$((RUN_SNAP + 1))
        shift
        ;;
      uv)
        RUN_UV=$((RUN_UV + 1))
        shift
        ;;
      rust)
        RUN_RUST=$((RUN_RUST + 1))
        shift
        ;;
      binenv)
        RUN_BINENV=$((RUN_BINENV + 1))
        shift
        ;;
      zsh)
        RUN_ZSH=$((RUN_ZSH + 1))
        shift
        ;;
      vim)
        RUN_VIM=$((RUN_VIM + 1))
        shift
        ;;
      *)
        shift
        ;;
    esac
  done
fi

if [[ $PROMPT -eq 0 ]]; then
  read -p "Running system & tooling update - continue (yY/nN)? " choice
  case "$choice" in
    y | Y) ;;

    n | N)
      exit 0
      ;;
    *)
      exit 0
      ;;
  esac
fi

XDG_DEV_HOME="${XDG_DEV_HOME:-$HOME/.local/dev}"
CONF_MK="${XDG_DEV_HOME}/configs/Makefile"

if [[ $RUN_APT -gt 0 ]]; then
  echo "Upgrading system programs..."
  sudo apt update
  sudo apt upgrade -y
  sudo apt autoremove -y
  sudo apt autoclean
fi

if [[ $RUN_SNAP -gt 0 ]]; then
  echo "Refreshing snaps..."
  sudo snap refresh
fi

if [[ "$(command -v uv)" ]] && [[ $RUN_UV -gt 0 ]]; then
  if [[ -f "${CONF_MK}" ]]; then
    echo "Upgrading uv..."
    make -f "${CONF_MK}" uv
  fi
  echo "Upgrading uv tools..."
  uv tool upgrade --compile-bytecode
fi

if [[ "$(command -v rustup)" ]] && [[ $RUN_RUST -gt 0 ]]; then
  echo "Upgrading Rust stable toolchain..."
  rustup update stable

  if [[ -f "${CONF_MK}" ]]; then
    # TODO: autoremove old/unused versions
    echo "Upgrading Rust applications & Cargo extensions..."
    make -f "${CONF_MK}" rust-tools cargo-tools
  fi
fi

binenv_upgrade() {
  local dist
  dist="$(echo $1 | cut -d: -f1)"

  # TODO: improvement - don't unnecessarily check for current (default) version
  local version
  version=$(
    echo $1 |
      # select release version list
      cut -d : -f 2 |
      # select only later releases than the currently installed one
      sed 's|(default).*||g' |
      tr " " "\n" |
      # filter out any RC/alpha/beta releases and non-version outputs
      egrep -v "rc|alpha|beta|^[[:space:]]*$" |
      # select the latest release version
      head -1 |
      # make sure to select only semantic version and strip color outputs
      egrep -o "[[:digit:]]+(\.[[:digit:]]+)+"
  )

  binenv install "${dist}" "${version}"
}

binenv_clean() {
  local dist
  dist="$(echo $1 | cut -d: -f1)"

  # TODO: improvement - silence or skip version which is not installed
  #  - Note: this can happen because `binenv_clean` is called even if `dist`
  #    was not recently updated
  # TODO: improvement - uninstall all non-default currently installed versions
  local version
  version=$(
    echo $1 |
      # select release version list
      cut -d : -f 2 |
      # select only earlier releases than the currently installed one
      sed -e 's|^.*(default)||g' |
      tr " " "\n" |
      tail -n +2 |
      # filter out any RC/alpha/beta releases and non-version outputs
      egrep -v "rc|alpha|beta|^[[:space:]]*$" |
      # select the latest release version
      head -1 |
      # make sure to select only semantic version and strip color outputs
      egrep -o "[[:digit:]]+(\.[[:digit:]]+)+"
  )

  binenv uninstall "${dist}" "${version}"
}

if [[ "$(command -v binenv)" ]] && [[ $RUN_BINENV -gt 0 ]]; then
  echo "Upgrading binenv distributions..."
  binenv update -a
  # upgrade binenv before any other distribution and refresh distribution list
  binenv_upgrade "$(binenv versions | grep binenv)"
  binenv update -a
  while read -r binenv_dist; do
    binenv_upgrade "${binenv_dist}"
    binenv_clean "${binenv_dist}"
  done <<<"$(binenv versions | grep default | grep -v binenv)"
fi

if [[ "$(command -v zsh)" ]] && [[ $RUN_ZSH -gt 0 ]]; then
  echo "Upgrading zsh plugins, snippets, and completions..."
  zsh -ic 'zinit update -a'
fi

if [[ -n "$EDITOR" ]] && [[ "$EDITOR" == *vim ]] && [[ $RUN_VIM -gt 0 ]]; then
  echo "Upgrading ${EDITOR} plugins..."
  "$EDITOR" --headless "+Lazy! sync" +qa &>/dev/null
fi
